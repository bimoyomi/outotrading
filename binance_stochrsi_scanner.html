<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ì´ë‚¸ìŠ¤ StochRSI %D < 1 ìŠ¤ìºë„ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-item label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .control-item input, .control-item select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .control-item input:focus, .control-item select:focus {
            outline: none;
            border-color: #007bff;
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            padding: 15px 30px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin: 20px 30px;
            border-radius: 0 8px 8px 0;
            font-weight: 500;
        }

        .status.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }

        .status.success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }

        .results {
            padding: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .results-count {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .symbol {
            font-weight: 700;
            color: #2c3e50;
        }

        .price {
            font-weight: 600;
            color: #28a745;
        }

        .price.negative {
            color: #dc3545;
        }

        .change {
            font-weight: 600;
        }

        .change.positive {
            color: #28a745;
        }

        .change.negative {
            color: #dc3545;
        }

        .rsi-value {
            font-weight: 600;
        }

        .rsi.oversold {
            color: #dc3545;
            background: #ffebee;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .rsi.overbought {
            color: #28a745;
            background: #e8f5e8;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .stoch-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #e83e8c;
            background: #fff0f5;
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .stoch.oversold {
            color: #ffffff;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 1.15rem;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .refresh-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1rem;
            }

            .controls {
                padding: 20px 15px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .control-item {
                width: 100%;
            }

            .btn {
                padding: 15px 20px;
                font-size: 1.1rem;
                width: 100%;
                margin-bottom: 10px;
            }

            .status {
                margin: 15px;
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .refresh-info {
                margin: 15px;
                padding: 12px 15px;
                font-size: 0.85rem;
            }

            .refresh-info > div {
                flex-direction: column;
                gap: 10px;
            }

            .refresh-info > div > div:last-child {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .refresh-info .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                margin-bottom: 0;
            }

            .results {
                padding: 20px 15px;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .results-title {
                font-size: 1.3rem;
            }

            .results-count {
                padding: 10px 15px;
                font-size: 0.9rem;
                align-self: center;
            }

            .table-container {
                border-radius: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 10px 8px;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            th {
                font-size: 0.8rem;
                padding: 12px 8px;
            }

            .symbol {
                font-size: 0.9rem;
                font-weight: 700;
            }

            .price {
                font-size: 0.85rem;
            }

            .change {
                font-size: 0.85rem;
            }

            .loading {
                padding: 30px 15px;
                font-size: 1rem;
            }

            .spinner {
                width: 35px;
                height: 35px;
                margin-bottom: 15px;
            }

            .no-results {
                padding: 40px 15px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .btn {
                padding: 12px 15px;
                font-size: 1rem;
            }

            th, td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }

            th {
                font-size: 0.75rem;
                padding: 10px 6px;
            }

            .symbol {
                font-size: 0.85rem;
            }

            .price {
                font-size: 0.8rem;
            }

            .change {
                font-size: 0.8rem;
            }

            .results-title {
                font-size: 1.2rem;
            }

            .results-count {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ë°”ì´ë‚¸ìŠ¤ StochRSI ìŠ¤ìºë„ˆ</h1>
            <p>ë‹¤ì–‘í•œ ì‹œê°„ ê°„ê²©ìœ¼ë¡œ ê´€ì‹¬ ì¢…ëª© (%Dâ‰¤5)ê³¼ ë§¤ìˆ˜ ì¢…ëª© (%D<1)ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="intervalSelect">ì‹œê°„ ê°„ê²©</label>
                    <select id="intervalSelect" class="control-item">
                        <option value="15m">15ë¶„</option>
                        <option value="30m">30ë¶„</option>
                        <option value="1h">1ì‹œê°„</option>
                        <option value="4h">4ì‹œê°„</option>
                        <option value="12h">12ì‹œê°„</option>
                        <option value="1d" selected>1ì¼</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <button id="specialCategoryBtn" class="btn" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">ë§¤ìˆ˜ ì¢…ëª© (%D<1)</button>
                <button id="hotSetBtn" class="btn" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">ê´€ì‹¬ ì¢…ëª© (%Dâ‰¤5)</button>
            </div>
        </div>

        <div id="status" class="status" style="display: none;"></div>
        <div id="refreshInfo" class="refresh-info" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="manualRefreshBtn" class="btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 8px 15px; font-size: 0.9rem;">ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨</button>
                    <button id="autoRefreshToggleBtn" class="btn" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); padding: 8px 15px; font-size: 0.9rem;">ìë™ ì—…ë°ì´íŠ¸ ì¤‘ì§€</button>
                </div>
            </div>
        </div>

        <div class="results">
            <div class="results-header">
                <div class="results-title">ê²€ìƒ‰ ê²°ê³¼</div>
                <div id="resultsCount" class="results-count">0ê°œ ì¢…ëª©</div>
            </div>
            <div id="resultsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    í˜ì´ì§€ ë¡œë”© ì¤‘... ìë™ìœ¼ë¡œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>

    <script>
        // ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í•¨ìˆ˜ë“¤
        // RSI (Wilder ë°©ë²•) - EMA ì‚¬ìš©
        function rsi(closes, r = 14) {
            if (closes.length < r + 1) {
                return Array(closes.length).fill(NaN);
            }
            
            const out = Array(closes.length).fill(NaN);
            const alpha = 1 / r; // EMA ì•ŒíŒŒê°’
            
            // ì´ˆê¸° gain/loss ê³„ì‚° (SMA)
            let gain = 0, loss = 0;
            for (let i = 1; i <= r; i++) {
                const ch = closes[i] - closes[i - 1];
                gain += Math.max(ch, 0);
                loss += Math.max(-ch, 0);
            }
            
            let avgG = gain / r, avgL = loss / r;
            
            // ì²« ë²ˆì§¸ RSI ê°’ ê³„ì‚°
            if (avgL === 0) {
                out[r] = 100;
            } else {
                out[r] = 100 - 100 / (1 + avgG / avgL);
            }
            
            // ë‚˜ë¨¸ì§€ RSI ê°’ë“¤ ê³„ì‚° (EMA ë°©ì‹)
            for (let i = r + 1; i < closes.length; i++) {
                const ch = closes[i] - closes[i - 1];
                const g = Math.max(ch, 0), l = Math.max(-ch, 0);
                
                // EMA ê³„ì‚°: EMA_t = alpha * value_t + (1 - alpha) * EMA_{t-1}
                avgG = alpha * g + (1 - alpha) * avgG;
                avgL = alpha * l + (1 - alpha) * avgL;
                
                if (avgL === 0) {
                    out[i] = 100;
                } else {
                    out[i] = 100 - 100 / (1 + avgG / avgL);
                }
            }
            
            return out;
        }

        function sma(arr, n) {
            const out = Array(arr.length).fill(NaN);
            let sum = 0;
            let count = 0;
            
            for (let i = 0; i < arr.length; i++) {
                if (!isNaN(arr[i])) {
                    sum += arr[i];
                    count++;
                }
                
                if (i >= n) {
                    if (!isNaN(arr[i - n])) {
                        sum -= arr[i - n];
                        count--;
                    }
                }
                
                if (count >= n) {
                    out[i] = sum / n;
                }
            }
            return out;
        }

        function stochRsiKD_fromCloses(closes, r = 14, n = 14, k = 3, d = 3) {
            // ìµœì†Œ ë°ì´í„° ê¸¸ì´ í™•ì¸ (ë” ê´€ëŒ€í•˜ê²Œ ì„¤ì •)
            const minLength = r + n + k + d;
            if (closes.length < minLength) {
                console.warn(`ë°ì´í„° ë¶€ì¡±: ${closes.length} < ${minLength}`);
                return { kNow: 0.5, dNow: 0.5, rsiNow: 50 };
            }

            // 1. RSI ê³„ì‚° (Wilder ë°©ë²•)
            const rsiValues = rsi(closes, r);
            console.log('RSI ê°’ë“¤:', rsiValues.slice(-10)); // ë””ë²„ê¹…ìš©
            
            // 2. StochRSI ê³„ì‚° (ê° ì‹œì ë§ˆë‹¤ í•´ë‹¹ ì‹œì ë¶€í„° nê°œ ê¸°ê°„ì˜ ìµœì†Œ/ìµœëŒ€ê°’ ì‚¬ìš©)
            const stochRsiValues = [];
            
            for (let i = r; i < rsiValues.length; i++) {
                const startIdx = Math.max(r, i - n + 1);
                const window = rsiValues.slice(startIdx, i + 1);
                
                // ìœˆë„ìš° í¬ê¸° ì¡°ê±´ì„ ë” ìœ ì—°í•˜ê²Œ
                if (window.length >= Math.min(n, 5)) { // ìµœì†Œ 5ê°œ ì´ìƒì´ë©´ ê³„ì‚°
                    const validWindow = window.filter(val => isFinite(val));
                    
                    if (validWindow.length >= Math.min(n, 5)) {
                        const minRsi = Math.min(...validWindow);
                        const maxRsi = Math.max(...validWindow);
                        const currentRsi = rsiValues[i];
                        
                        if (maxRsi !== minRsi && isFinite(currentRsi) && isFinite(minRsi) && isFinite(maxRsi)) {
                            const stochRsi = (currentRsi - minRsi) / (maxRsi - minRsi);
                            stochRsiValues.push(Math.max(0, Math.min(1, stochRsi)));
                        } else {
                            stochRsiValues.push(0.5); // ê¸°ë³¸ê°’
                        }
                    } else {
                        stochRsiValues.push(0.5); // ê¸°ë³¸ê°’
                    }
                } else {
                    stochRsiValues.push(0.5); // ê¸°ë³¸ê°’
                }
            }
            
            console.log('StochRSI ê°’ë“¤:', stochRsiValues.slice(-10)); // ë””ë²„ê¹…ìš©
            
            // 3. %K ê³„ì‚° (StochRSIì˜ kê¸°ê°„ SMA)
            const kValues = sma(stochRsiValues, k);
            console.log('%K ê°’ë“¤:', kValues.slice(-10)); // ë””ë²„ê¹…ìš©
            
            // 4. %D ê³„ì‚° (%Kì˜ dê¸°ê°„ SMA)
            const dValues = sma(kValues, d);
            console.log('%D ê°’ë“¤:', dValues.slice(-10)); // ë””ë²„ê¹…ìš©
            
            // í˜„ì¬ ê°’ë“¤ ë°˜í™˜
            const currentK = kValues[kValues.length - 1];
            const currentD = dValues[dValues.length - 1];
            const currentRsi = rsiValues[rsiValues.length - 1];
            
            console.log(`ìµœì¢… ê°’ë“¤ - RSI: ${currentRsi}, %K: ${currentK}, %D: ${currentD}`);
            
            return { 
                kNow: isFinite(currentK) ? currentK : 0.5, 
                dNow: isFinite(currentD) ? currentD : 0.5, 
                rsiNow: isFinite(currentRsi) ? currentRsi : 50 
            };
        }

        // ì „ì—­ ë³€ìˆ˜
        let isScanning = false;
        let scanInterval = null;
        let allSymbols = [];
        let filteredResults = [];
        let hotSet = []; // ìŠ¤ìº” ê²°ê³¼ (ê´€ì‹¬ ì¢…ëª© ë²„íŠ¼ìš©) - %D â‰¤ 5ì¸ ì¢…ëª©ë“¤
        let specialCategory = []; // ë§¤ìˆ˜ ì¢…ëª© - %D < 1ì¸ ì¢…ëª©ë“¤

        // DOM ìš”ì†Œë“¤
        const hotSetBtn = document.getElementById('hotSetBtn');
        const specialCategoryBtn = document.getElementById('specialCategoryBtn');
        const manualRefreshBtn = document.getElementById('manualRefreshBtn');
        const autoRefreshToggleBtn = document.getElementById('autoRefreshToggleBtn');
        const statusDiv = document.getElementById('status');
        const refreshInfoDiv = document.getElementById('refreshInfo');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsCount = document.getElementById('resultsCount');
        const lastUpdateSpan = document.getElementById('lastUpdate');
        const intervalSelect = document.getElementById('intervalSelect');

        // ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸° (ê³ ì •ê°’ ì‚¬ìš©)
        function getSettings() {
            return {
                rsiPeriod: 14,        // ê³ ì •ê°’
                stochPeriod: 14,      // ê³ ì •ê°’
                kPeriod: 3,           // ê³ ì •ê°’
                dPeriod: 3,           // ê³ ì •ê°’
                interval: intervalSelect.value  // ì„ íƒëœ ì‹œê°„ ê°„ê²©
            };
        }

        // ìƒíƒœ í‘œì‹œ
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        // í•˜ë“œì½”ë”©ëœ ì£¼ìš” ì‹¬ë³¼ ëª©ë¡ (ë°±ì—…ìš©)
        const MAJOR_SYMBOLS = [
            'BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'ADAUSDT', 'XRPUSDT',
            'SOLUSDT', 'DOTUSDT', 'DOGEUSDT', 'AVAXUSDT', 'SHIBUSDT',
            'MATICUSDT', 'LTCUSDT', 'UNIUSDT', 'LINKUSDT', 'ATOMUSDT',
            'VETUSDT', 'FILUSDT', 'TRXUSDT', 'ETCUSDT', 'XLMUSDT',
            'BCHUSDT', 'ALGOUSDT', 'ICPUSDT', 'THETAUSDT', 'EOSUSDT',
            'AAVEUSDT', 'SUSHIUSDT', 'COMPUSDT', 'YFIUSDT', 'SNXUSDT',
            'MKRUSDT', 'CRVUSDT', '1INCHUSDT', 'UMAUSDT', 'BALUSDT',
            'ZRXUSDT', 'BATUSDT', 'ZECUSDT', 'DASHUSDT', 'NEOUSDT',
            'QTUMUSDT', 'IOTAUSDT', 'ONTUSDT', 'ZILUSDT', 'OMGUSDT'
        ];

        // ê°„ë‹¨í•œ fetch í•¨ìˆ˜ (CORS ìš°íšŒ ì—†ì´, ì¬ì‹œë„ ë¡œì§ í¬í•¨)
        async function fetchWithProxy(url, retries = 3) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    console.log(`API í˜¸ì¶œ (ì‹œë„ ${attempt}/${retries}): ${url}`);
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        console.log('API í˜¸ì¶œ ì„±ê³µ!');
                        return response;
                    } else if (response.status === 429) {
                        // Rate limit ì˜¤ë¥˜ì¸ ê²½ìš° ë” ì˜¤ë˜ ëŒ€ê¸°
                        const waitTime = Math.pow(2, attempt) * 1000; // 2ì´ˆ, 4ì´ˆ, 8ì´ˆ
                        console.warn(`Rate limit ë„ë‹¬. ${waitTime/1000}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn(`API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempt}/${retries}):`, error.message);
                    if (attempt === retries) {
                        throw error;
                    }
                    // ì¬ì‹œë„ ì „ì— ì ì‹œ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        // ì‹¬ë³¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ëª¨ë“  USDT-m futures ì¢…ëª©)
        async function fetchSymbols() {
            try {
                console.log('ë°”ì´ë‚¸ìŠ¤ APIì—ì„œ ëª¨ë“  USDT-m futures ì¢…ëª© ê°€ì ¸ì˜¤ê¸°...');
                showStatus('ëª¨ë“  USDT-m futures ì¢…ëª©ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'info');
                
                const response = await fetchWithProxy('https://fapi.binance.com/fapi/v1/exchangeInfo');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Exchange Info ì‘ë‹µ:', data);
                
                if (!data.symbols || !Array.isArray(data.symbols)) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ êµ¬ì¡°');
                }
                
                // USDT-m futures ì¢…ëª©ë§Œ í•„í„°ë§
                const usdtSymbols = data.symbols
                    .filter(symbol => 
                        symbol.status === 'TRADING' && 
                        symbol.symbol.endsWith('USDT') &&
                        symbol.contractType === 'PERPETUAL'
                    )
                    .map(symbol => symbol.symbol)
                    .sort();
                
                console.log(`ì´ ${usdtSymbols.length}ê°œ USDT-m futures ì¢…ëª© ë°œê²¬`);
                console.log('ë°œê²¬ëœ ì¢…ëª©ë“¤ (ì²˜ìŒ 20ê°œ):', usdtSymbols.slice(0, 20));
                console.log('ë°œê²¬ëœ ì¢…ëª©ë“¤ (ë§ˆì§€ë§‰ 20ê°œ):', usdtSymbols.slice(-20));
                console.log('ì „ì²´ ì¢…ëª© ëª©ë¡:', usdtSymbols);
                
                // ìµœì†Œ ì¢…ëª© ìˆ˜ í™•ì¸ (ì¼ë°˜ì ìœ¼ë¡œ 200ê°œ ì´ìƒì´ì–´ì•¼ í•¨)
                if (usdtSymbols.length < 100) {
                    console.warn(`ê²½ê³ : ì˜ˆìƒë³´ë‹¤ ì ì€ ì¢…ëª© ìˆ˜ (${usdtSymbols.length}ê°œ). API ì‘ë‹µì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.`);
                }
                
                showStatus(`${usdtSymbols.length}ê°œ USDT-m futures ì¢…ëª©ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, 'success');
                
                return usdtSymbols;
                
            } catch (error) {
                console.error('APIì—ì„œ ì¢…ëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                console.log('ë°±ì—…ìœ¼ë¡œ ì£¼ìš” ì‹¬ë³¼ ëª©ë¡ ì‚¬ìš©...');
                showStatus(`API ì˜¤ë¥˜ë¡œ ì¸í•´ ${MAJOR_SYMBOLS.length}ê°œ ì£¼ìš” ì‹¬ë³¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.`, 'error');
                return MAJOR_SYMBOLS;
            }
        }

        // ìŠ¤ìº”: ì„ íƒëœ ì‹œê°„ ê°„ê²© ê¸°ì¤€ %Dâ‰¤5% ì¢…ëª© ì„ ë³„ (ê´€ì‹¬ ì¢…ëª©) ë° %D<1% ì¢…ëª© ì„ ë³„ (ë§¤ìˆ˜ ì¢…ëª©)
        async function scanSymbols(symbols, settings) {
            console.log('=== ìŠ¤ìº” ì‹œì‘ ===');
            console.log(`ì‹œê°„ ê°„ê²©: ${settings.interval}`);
            console.log(`ì „ì²´ ${symbols.length}ê°œ ì¢…ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.`);
            console.log('ìŠ¤ìº”í•  ì¢…ëª©ë“¤ (ì²˜ìŒ 10ê°œ):', symbols.slice(0, 10));
            console.log('ìŠ¤ìº”í•  ì¢…ëª©ë“¤ (ë§ˆì§€ë§‰ 10ê°œ):', symbols.slice(-10));
            showStatus(`ì „ì²´ ${symbols.length}ê°œ ì¢…ëª© ì¤‘ ${settings.interval} ê°„ê²©ìœ¼ë¡œ %Dâ‰¤5% ì¢…ëª© ì„ ë³„ ì¤‘...`, 'info');
            
            const hotSetResults = []; // ê´€ì‹¬ ì¢…ëª©: %D â‰¤ 5ì¸ ì¢…ëª©ë“¤
            const specialResults = []; // ë§¤ìˆ˜ ì¢…ëª©: %D < 1ì¸ ì¢…ëª©ë“¤
            const batchSize = 10; // ë°°ì¹˜ í¬ê¸° ì¦ê°€ (ì²˜ë¦¬ ì†ë„ í–¥ìƒ)
            let processedCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < symbols.length; i += batchSize) {
                if (!isScanning) break;
                
                const batch = symbols.slice(i, i + batchSize);
                const batchPromises = batch.map(symbol => analyzeSymbolForHotSet(symbol, settings));
                
                try {
                    const batchResults = await Promise.allSettled(batchPromises);
                    const validResults = batchResults
                        .filter(result => result.status === 'fulfilled' && result.value !== null)
                        .map(result => result.value);
                    
                    const batchErrors = batchResults
                        .filter(result => result.status === 'rejected')
                        .length;
                    
                    // ê²°ê³¼ë¥¼ ë‘ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜
                    validResults.forEach(result => {
                        if (result.dValue < 1) {
                            specialResults.push(result); // ë§¤ìˆ˜ ì¢…ëª©: %D < 1
                        }
                        if (result.dValue <= 5) {
                            hotSetResults.push(result); // ê´€ì‹¬ ì¢…ëª©: %D â‰¤ 5
                        }
                    });
                    
                    processedCount += batch.length;
                    errorCount += batchErrors;
                    
                    const progress = Math.min(i + batchSize, symbols.length);
                    const percentage = Math.round((progress / symbols.length) * 100);
                    showStatus(`ì§„í–‰: ${progress}/${symbols.length}ê°œ ì¢…ëª© ë¶„ì„ (${percentage}%) - ê´€ì‹¬ ì¢…ëª©: ${hotSetResults.length}ê°œ, ë§¤ìˆ˜ ì¢…ëª©: ${specialResults.length}ê°œ, ì˜¤ë¥˜: ${errorCount}ê°œ`, 'info');
                    
                    console.log(`ë°°ì¹˜ ${Math.floor(i/batchSize) + 1}: ${batch.length}ê°œ ì²˜ë¦¬, ${validResults.length}ê°œ ì„±ê³µ, ${batchErrors}ê°œ ì‹¤íŒ¨`);
                    
            } catch (error) {
                    console.error('ë°°ì¹˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    errorCount += batch.length;
                }
                
                await new Promise(resolve => setTimeout(resolve, 500)); // 0.5ì´ˆ ëŒ€ê¸°ë¡œ ë‹¨ì¶•
            }
            
            // ê±°ë˜ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            hotSetResults.sort((a, b) => b.volumeUsdt - a.volumeUsdt);
            specialResults.sort((a, b) => b.volumeUsdt - a.volumeUsdt);
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            hotSet = hotSetResults; // ê´€ì‹¬ ì¢…ëª©: %D â‰¤ 5ì¸ ì¢…ëª©ë“¤
            specialCategory = specialResults; // ë§¤ìˆ˜ ì¢…ëª©: %D < 1ì¸ ì¢…ëª©ë“¤
            
            console.log(`=== ìŠ¤ìº” ì™„ë£Œ ===`);
            console.log(`ì „ì²´ ì²˜ë¦¬ëœ ì¢…ëª©: ${processedCount}/${symbols.length}ê°œ`);
            console.log(`ì˜¤ë¥˜ ë°œìƒ: ${errorCount}ê°œ`);
            console.log(`ê´€ì‹¬ ì¢…ëª© (%D â‰¤ 5): ${hotSetResults.length}ê°œ`);
            console.log(`ë§¤ìˆ˜ ì¢…ëª© (%D < 1): ${specialResults.length}ê°œ`);
            console.log('ê´€ì‹¬ ì¢…ëª©ë“¤:', hotSetResults.map(item => `${item.symbol}(${item.dValue.toFixed(2)}%)`));
            console.log('ë§¤ìˆ˜ ì¢…ëª©ë“¤:', specialResults.map(item => `${item.symbol}(${item.dValue.toFixed(2)}%)`));
            
            // ì²˜ë¦¬ ì™„ë£Œìœ¨ í™•ì¸
            const completionRate = Math.round((processedCount / symbols.length) * 100);
            if (completionRate < 95) {
                console.warn(`ê²½ê³ : ì „ì²´ ì¢…ëª©ì˜ ${completionRate}%ë§Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ì¢…ëª©ì´ ëˆ„ë½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                showStatus(`ê²½ê³ : ${completionRate}%ë§Œ ì²˜ë¦¬ë¨. ì¼ë¶€ ì¢…ëª©ì´ ëˆ„ë½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'error');
            } else {
                showStatus(`ìŠ¤ìº” ì™„ë£Œ: ê´€ì‹¬ ì¢…ëª© ${hotSetResults.length}ê°œ, ë§¤ìˆ˜ ì¢…ëª© ${specialResults.length}ê°œ ë°œê²¬ (${completionRate}% ì²˜ë¦¬ ì™„ë£Œ)`, 'success');
            }
            
            return { hotSet: hotSetResults, specialCategory: specialResults };
        }

        // ì¢…ëª© ë¶„ì„ (ì„ íƒëœ ì‹œê°„ ê°„ê²© ê¸°ì¤€, %D â‰¤ 5ì¸ ì¢…ëª© ì„ ë³„)
        async function analyzeSymbolForHotSet(symbol, settings) {
            try {
                const [stats, klineData] = await Promise.all([
                    fetch24hrStats(symbol),
                    fetchKlineData(symbol, settings.interval, 200)
                ]);

                if (!stats || !klineData || klineData.length < 50) {
                    return null;
                }

                // ê°€ê²© ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                const price = parseFloat(stats.lastPrice);
                const change = parseFloat(stats.priceChange);
                const changePercent = parseFloat(stats.priceChangePercent);
                const volume = parseFloat(stats.volume);

                if (isNaN(price) || isNaN(change) || isNaN(changePercent) || isNaN(volume)) {
                    return null;
                }

                const closes = klineData.map(k => k.close);
                
                if (closes.some(c => isNaN(c) || c <= 0)) {
                    return null;
                }

                // ì¤‘ìš”: ì„ íƒëœ ì‹œê°„ ê°„ê²©ì˜ ë§ˆì§€ë§‰ ê°€ê²©ì„ í˜„ì¬ê°€ë¡œ ì—…ë°ì´íŠ¸
                // ìŠ¤ìº” ì‹œì ì˜ í˜„ì¬ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ StochRSI ê³„ì‚°
                const closesWithCurrentPrice = [...closes];
                closesWithCurrentPrice[closesWithCurrentPrice.length - 1] = price;

                const stochRsi = stochRsiKD_fromCloses(
                    closesWithCurrentPrice, 
                    settings.rsiPeriod, 
                    settings.stochPeriod, 
                    settings.kPeriod, 
                    settings.dPeriod
                );

                // í¼ì„¼íŠ¸ ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜
                const dValuePercent = isFinite(stochRsi.dNow) ? stochRsi.dNow * 100 : NaN;
                
                // ì¡°ê±´: %D â‰¤ 5% (ì„ íƒëœ ì‹œê°„ ê°„ê²© ê¸°ì¤€) - ê´€ì‹¬ ì¢…ëª©ìš©
                if (isFinite(stochRsi.dNow) && dValuePercent <= 5) {
                    return {
                        symbol: symbol,
                        price: price,
                        change: change,
                        changePercent: changePercent,
                        volume: volume,
                        volumeUsdt: volume * price,
                        rsi: stochRsi.rsiNow,
                        kValue: stochRsi.kNow * 100,
                        dValue: dValuePercent,
                        timestamp: new Date().toLocaleTimeString()
                    };
                }

                return null;
            } catch (error) {
                console.error(`${symbol} ë¶„ì„ ì‹¤íŒ¨:`, error);
                return null;
            }
        }

        // ë°”ì´ë‚¸ìŠ¤ APIì—ì„œ 24ì‹œê°„ í†µê³„ ê°€ì ¸ì˜¤ê¸°
        async function fetch24hrStats(symbol) {
            try {
                const response = await fetchWithProxy(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`);
                
                if (!response.ok) {
                    console.warn(`${symbol} í†µê³„ API ì˜¤ë¥˜: ${response.status}`);
                    return null;
                }
                
                const data = await response.json();
                
                // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (!data || typeof data.lastPrice === 'undefined' || typeof data.priceChange === 'undefined') {
                    console.warn(`${symbol}: ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° êµ¬ì¡°`, data);
                    return null;
                }
                
                // NaN ê°’ ì²´í¬
                if (isNaN(parseFloat(data.lastPrice)) || isNaN(parseFloat(data.priceChange))) {
                    console.warn(`${symbol}: ê°€ê²© ë°ì´í„°ì— NaN í¬í•¨`, data);
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error(`${symbol} í†µê³„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, error);
                return null;
            }
        }

        // ë°”ì´ë‚¸ìŠ¤ APIì—ì„œ Kline ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchKlineData(symbol, interval = '1h', limit = 200) {
            try {
                const response = await fetchWithProxy(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
                
                if (!response.ok) {
                    console.warn(`${symbol} Kline API ì˜¤ë¥˜: ${response.status}`);
                    return null;
                }
                
                const data = await response.json();
                return data.map(k => ({
                    open: parseFloat(k[1]),
                    high: parseFloat(k[2]),
                    low: parseFloat(k[3]),
                    close: parseFloat(k[4]),
                    volume: parseFloat(k[5])
                }));
            } catch (error) {
                console.error(`${symbol} Kline ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, error);
                return null;
            }
        }

        // 1ì¼ë´‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchDailyKlineData(symbol, limit = 100) {
            return await fetchKlineData(symbol, '1d', limit);
        }



        // ì¢…ëª© ë¶„ì„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
        async function analyzeSymbol(symbol, settings) {
            try {
                const [stats, klineData] = await Promise.all([
                    fetch24hrStats(symbol),
                    fetchKlineData(symbol)
                ]);

                if (!stats || !klineData || klineData.length < 50) {
                    console.log(`${symbol}: ë°ì´í„° ë¶€ì¡± - stats: ${!!stats}, klineData: ${klineData?.length || 0}`);
                    return null;
                }

                // ê°€ê²© ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                const price = parseFloat(stats.lastPrice);
                const change = parseFloat(stats.priceChange);
                const changePercent = parseFloat(stats.priceChangePercent);
                const volume = parseFloat(stats.volume);

                if (isNaN(price) || isNaN(change) || isNaN(changePercent) || isNaN(volume)) {
                    console.log(`${symbol}: ê°€ê²© ë°ì´í„°ì— NaN í¬í•¨ - price: ${price}, change: ${change}, changePercent: ${changePercent}, volume: ${volume}`);
                    return null;
                }

                const closes = klineData.map(k => k.close);
                
                // Kline ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (closes.some(c => isNaN(c) || c <= 0)) {
                    console.log(`${symbol}: Kline ë°ì´í„°ì— ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ í¬í•¨`);
                    return null;
                }

                // ì¤‘ìš”: ë§ˆì§€ë§‰ ê°€ê²©ì„ í˜„ì¬ê°€ë¡œ ì—…ë°ì´íŠ¸
                const closesWithCurrentPrice = [...closes];
                closesWithCurrentPrice[closesWithCurrentPrice.length - 1] = price;
                console.log(`${symbol}: ë§ˆì§€ë§‰ ê°€ê²©ì„ í˜„ì¬ê°€(${price})ë¡œ ì—…ë°ì´íŠ¸`);

                const stochRsi = stochRsiKD_fromCloses(
                    closesWithCurrentPrice, 
                    settings.rsiPeriod, 
                    settings.stochPeriod, 
                    settings.kPeriod, 
                    settings.dPeriod
                );

                // í¼ì„¼íŠ¸ ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜
                const dValuePercent = isFinite(stochRsi.dNow) ? stochRsi.dNow * 100 : NaN;
                console.log(`${symbol}: RSI=${stochRsi.rsiNow?.toFixed(2)}, %K=${(stochRsi.kNow * 100)?.toFixed(2)}, %D=${dValuePercent?.toFixed(2)}`);

                // %D ê°’ì´ ìœ íš¨í•˜ê³  1% ë¯¸ë§Œì¸ ê²½ìš°ë§Œ ë°˜í™˜ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
                if (isFinite(stochRsi.dNow) && dValuePercent < 1) {
                    console.log(`âœ… ${symbol}: ì¡°ê±´ ë§Œì¡±! %D=${dValuePercent.toFixed(2)} < 1%`);
                    return {
                        symbol: symbol,
                        price: price,
                        change: change,
                        changePercent: changePercent,
                        volume: volume,
                        rsi: stochRsi.rsiNow,
                        kValue: stochRsi.kNow * 100,
                        dValue: dValuePercent,
                        timestamp: new Date().toLocaleTimeString()
                    };
                }

                return null;
            } catch (error) {
                console.error(`${symbol} ë¶„ì„ ì‹¤íŒ¨:`, error);
                return null;
            }
        }

        // ê²°ê³¼ í…Œì´ë¸” ìƒì„±
        function createResultsTable(results) {
            if (results.length === 0) {
                return '<div class="no-results">ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            // %D ê°’ìœ¼ë¡œ ì •ë ¬ (ë‚®ì€ ìˆœ)
            results.sort((a, b) => a.dValue - b.dValue);

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ì‹¬ë³¼</th>
                                <th>%D</th>
                                <th>í˜„ì¬ê°€</th>
                                <th>ë³€ë™ë¥ </th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach(item => {
                const changeClass = item.changePercent >= 0 ? 'positive' : 'negative';
                const stochClass = item.dValue < 20 ? 'oversold' : '';

                tableHTML += `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="stoch-value ${stochClass}">${item.dValue.toFixed(2)}</td>
                        <td class="price ${item.changePercent < 0 ? 'negative' : ''}">$${item.price.toFixed(4)}</td>
                        <td class="change ${changeClass}">${item.changePercent >= 0 ? '+' : ''}${item.changePercent.toFixed(2)}%</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            return tableHTML;
        }

        // ìŠ¤ìº” ì‹¤í–‰
        async function runScan() {
            if (isScanning) return;

            isScanning = true;

            try {
                showStatus('ì „ì²´ USDT-m futures ì¢…ëª© ìŠ¤ìº” ì‹œì‘...', 'info');
                
                if (allSymbols.length === 0) {
                    allSymbols = await fetchSymbols();
                }

                const settings = getSettings();
                console.log('=== ìŠ¤ìº” ì‹œì‘ ===');
                console.log('ìŠ¤ìº” ì„¤ì •:', settings);
                console.log(`ì „ì²´ ìŠ¤ìº” ëŒ€ìƒ: ${allSymbols.length}ê°œ USDT-m futures ì¢…ëª©`);
                console.log(`ìŠ¤ìº” ì¡°ê±´: ê´€ì‹¬ ì¢…ëª© (%D â‰¤ 5%), ë§¤ìˆ˜ ì¢…ëª© (%D < 1%) (${settings.interval} ê°„ê²© ê¸°ì¤€, í˜„ì¬ê°€ ë°˜ì˜)`);
                
                // ìŠ¤ìº” ì‹¤í–‰
                const scanResults = await scanSymbols(allSymbols, settings);
                
                // ê²°ê³¼ í‘œì‹œ (ê¸°ë³¸ì ìœ¼ë¡œ ë§¤ìˆ˜ ì¢…ëª© í‘œì‹œ)
                filteredResults = scanResults.specialCategory;
                resultsCount.textContent = `${scanResults.specialCategory.length}ê°œ ì¢…ëª©`;
                resultsContainer.innerHTML = createResultsTable(scanResults.specialCategory);

                if (scanResults.specialCategory.length > 0) {
                    showStatus(`ìŠ¤ìº” ì™„ë£Œ! ë§¤ìˆ˜ ì¢…ëª© ${scanResults.specialCategory.length}ê°œ, ê´€ì‹¬ ì¢…ëª© ${scanResults.hotSet.length}ê°œ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    showStatus(`ìŠ¤ìº” ì™„ë£Œ! ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.`, 'info');
                }

                // ìŠ¤ìº” ì™„ë£Œ í›„ ìë™ ì—…ë°ì´íŠ¸ ì •ë³´ ê°±ì‹ 
                updateRefreshInfo();

            } catch (error) {
                console.error('ìŠ¤ìº” ì˜¤ë¥˜:', error);
                showStatus(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                resultsContainer.innerHTML = '<div class="no-results">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ìë™ ì—…ë°ì´íŠ¸ëŠ” ê³„ì† ì‘ë™í•˜ë„ë¡ í•¨
                console.log('ì˜¤ë¥˜ ë°œìƒí–ˆì§€ë§Œ ìë™ ì—…ë°ì´íŠ¸ëŠ” ê³„ì† ì‘ë™í•©ë‹ˆë‹¤.');
            } finally {
                isScanning = false;
            }
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
        function startAutoRefresh() {
            if (scanInterval) clearInterval(scanInterval);
            
            scanInterval = setInterval(() => {
                console.log('ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘...');
                if (isScanning) {
                    console.log('í˜„ì¬ ìŠ¤ìº” ì¤‘ì´ë¯€ë¡œ ê±´ë„ˆëœ€');
                    return;
                }
                runScan();
            }, 300000); // 5ë¶„ë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨

            refreshInfoDiv.style.display = 'block';
            updateRefreshInfo();
            updateAutoRefreshButton();
            console.log('ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘ë¨ - 5ë¶„ë§ˆë‹¤ ì‹¤í–‰');
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        function stopAutoRefresh() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
                console.log('ìë™ ì—…ë°ì´íŠ¸ ì¤‘ì§€ë¨');
            }
            // ìë™ ì—…ë°ì´íŠ¸ê°€ ì¤‘ì§€ë˜ì–´ë„ ë²„íŠ¼ì€ ê³„ì† ë³´ì´ë„ë¡ í•¨
            refreshInfoDiv.style.display = 'block';
            updateAutoRefreshButton();
        }

        // ìë™ ì—…ë°ì´íŠ¸ ìƒíƒœ í™•ì¸
        function isAutoRefreshActive() {
            return scanInterval !== null;
        }

        // ìë™ ì—…ë°ì´íŠ¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAutoRefreshButton() {
            if (isAutoRefreshActive()) {
                autoRefreshToggleBtn.textContent = 'ìë™ ì—…ë°ì´íŠ¸ ì¤‘ì§€';
                autoRefreshToggleBtn.style.background = 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)';
            } else {
                autoRefreshToggleBtn.textContent = 'ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘';
                autoRefreshToggleBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            }
        }

        // ìƒˆë¡œê³ ì¹¨ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateRefreshInfo() {
            const now = new Date();
            lastUpdateSpan.textContent = now.toLocaleTimeString();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ

        // ê´€ì‹¬ ì¢…ëª© ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        hotSetBtn.addEventListener('click', () => {
            if (hotSet.length === 0) {
                showStatus('ê´€ì‹¬ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ìº”ì„ ì‹¤í–‰í•˜ì„¸ìš”.', 'info');
                resultsContainer.innerHTML = '<div class="no-results">ê´€ì‹¬ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ìº”ì„ ì‹¤í–‰í•˜ì„¸ìš”.</div>';
                resultsCount.textContent = '0ê°œ ì¢…ëª©';
                return;
            }
            
            showStatus(`ê´€ì‹¬ ì¢…ëª© (%Dâ‰¤5) ${hotSet.length}ê°œ ì¢…ëª© í‘œì‹œ`, 'info');
            resultsCount.textContent = `${hotSet.length}ê°œ ê´€ì‹¬ ì¢…ëª©`;
            resultsContainer.innerHTML = createResultsTable(hotSet);
        });

        // ë§¤ìˆ˜ ì¢…ëª© ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        specialCategoryBtn.addEventListener('click', () => {
            if (specialCategory.length === 0) {
                showStatus('ë§¤ìˆ˜ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ìº”ì„ ì‹¤í–‰í•˜ì„¸ìš”.', 'info');
                resultsContainer.innerHTML = '<div class="no-results">ë§¤ìˆ˜ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ìº”ì„ ì‹¤í–‰í•˜ì„¸ìš”.</div>';
                resultsCount.textContent = '0ê°œ ì¢…ëª©';
                return;
            }
            
            showStatus(`ë§¤ìˆ˜ ì¢…ëª© (%D<1) ${specialCategory.length}ê°œ ì¢…ëª© í‘œì‹œ`, 'info');
            resultsCount.textContent = `${specialCategory.length}ê°œ ë§¤ìˆ˜ ì¢…ëª©`;
            resultsContainer.innerHTML = createResultsTable(specialCategory);
        });

        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        manualRefreshBtn.addEventListener('click', async () => {
            if (isScanning) {
                showStatus('í˜„ì¬ ìŠ¤ìº” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'info');
                return;
            }
            
            showStatus('ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            console.log('ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            await runScan();
        });

        // ìë™ ì—…ë°ì´íŠ¸ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        autoRefreshToggleBtn.addEventListener('click', () => {
            if (isAutoRefreshActive()) {
                stopAutoRefresh();
                showStatus('ìë™ ì—…ë°ì´íŠ¸ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                console.log('ìë™ ì—…ë°ì´íŠ¸ ì¤‘ì§€ë¨');
            } else {
                startAutoRefresh();
                showStatus('ìë™ ì—…ë°ì´íŠ¸ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                console.log('ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘ë¨');
            }
        });

        // ì‹œê°„ ê°„ê²© ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        intervalSelect.addEventListener('change', async () => {
            if (isScanning) {
                showStatus('í˜„ì¬ ìŠ¤ìº” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'info');
                return;
            }
            
            const selectedInterval = intervalSelect.value;
            showStatus(`ì‹œê°„ ê°„ê²©ì´ ${selectedInterval}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤...`, 'info');
            console.log(`ì‹œê°„ ê°„ê²© ë³€ê²½: ${selectedInterval}`);
            await runScan();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ìë™ ìŠ¤ìº” ì‹œì‘
        document.addEventListener('DOMContentLoaded', async () => {
            showStatus('ìë™ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ìë™ ìŠ¤ìº” ì‹œì‘');
            
            // í˜ì´ì§€ ë¡œë“œ í›„ 1ì´ˆ ë’¤ì— ìë™ìœ¼ë¡œ ìŠ¤ìº” ì‹œì‘
            setTimeout(async () => {
                try {
                    await runScan();
                    startAutoRefresh();
                    console.log('ì´ˆê¸° ìŠ¤ìº” ì™„ë£Œ ë° ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘');
                } catch (error) {
                    console.error('ì´ˆê¸° ìŠ¤ìº” ì‹¤íŒ¨:', error);
                    showStatus('ì´ˆê¸° ìŠ¤ìº” ì‹¤íŒ¨í–ˆì§€ë§Œ ìë™ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'error');
                    // ì´ˆê¸° ìŠ¤ìº”ì´ ì‹¤íŒ¨í•´ë„ ìë™ ì—…ë°ì´íŠ¸ëŠ” ì‹œì‘
                    startAutoRefresh();
                }
            }, 1000);
        });
    </script>
</body>
</html>
